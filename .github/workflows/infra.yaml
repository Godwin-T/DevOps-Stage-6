name: Terraform Plan & Drift Guard

on:
  push:
    paths:
      - "infra/**"
      - ".github/workflows/infra.yaml"
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

env:
  TF_WORKING_DIR: infra/terraform

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform fmt
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TF_VAR_auth_jwt_secret: ${{ secrets.AUTH_JWT_SECRET }}
          TF_VAR_todos_jwt_secret: ${{ secrets.TODOS_JWT_SECRET }}
          TF_VAR_users_jwt_secret: ${{ secrets.USERS_JWT_SECRET }}
        run: terraform init -input=false

      - name: Terraform plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TF_VAR_auth_jwt_secret: ${{ secrets.AUTH_JWT_SECRET }}
          TF_VAR_todos_jwt_secret: ${{ secrets.TODOS_JWT_SECRET }}
          TF_VAR_users_jwt_secret: ${{ secrets.USERS_JWT_SECRET }}
        run: |
          set +e
          terraform plan -detailed-exitcode -out=tfplan
          code=$?
          if [ $code -eq 1 ]; then exit 1; fi
          echo "exitcode=$code" >> "$GITHUB_OUTPUT"

      - name: Capture plan text
        if: steps.plan.outputs.exitcode == '2'
        id: show
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform show -no-color tfplan > plan.txt
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat plan.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Email drift alert
        if: steps.plan.outputs.exitcode == '2'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[Terraform] Drift detected for devops-stage6"
          to: ${{ secrets.DRIFT_EMAIL_TO }}
          from: Terraform Bot
          content_type: text/plain
          body: ${{ steps.show.outputs.body }}

      - name: Upload plan artifact
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_WORKING_DIR }}/tfplan

  apply:
    needs: plan
    if: needs.plan.outputs.exitcode == '2'
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TF_VAR_auth_jwt_secret: ${{ secrets.AUTH_JWT_SECRET }}
          TF_VAR_todos_jwt_secret: ${{ secrets.TODOS_JWT_SECRET }}
          TF_VAR_users_jwt_secret: ${{ secrets.USERS_JWT_SECRET }}
        run: terraform init -input=false

      - name: Terraform apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TF_VAR_auth_jwt_secret: ${{ secrets.AUTH_JWT_SECRET }}
          TF_VAR_todos_jwt_secret: ${{ secrets.TODOS_JWT_SECRET }}
          TF_VAR_users_jwt_secret: ${{ secrets.USERS_JWT_SECRET }}
        run: terraform apply -input=false tfplan
