name: Terraform Plan & Drift Guard

on:
  push:
    paths:
      - "infra/**"
      - ".github/workflows/infra.yaml"
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

env:
  TF_WORKING_DIR: infra/terraform

jobs:
  plan:
    runs-on: ubuntu-latest
    env:
      TF_VAR_base_domain: ${{ secrets.BASE_DOMAIN }}
      TF_VAR_traefik_acme_email: ${{ secrets.TRAEFIK_ACME_EMAIL }}
      TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      TF_VAR_auth_jwt_secret: ${{ secrets.AUTH_JWT_SECRET }}
      TF_VAR_todos_jwt_secret: ${{ secrets.TODOS_JWT_SECRET }}
      TF_VAR_users_jwt_secret: ${{ secrets.USERS_JWT_SECRET }}
    outputs:
      drift_detected: ${{ steps.plan.outputs.drift_detected }}
    steps:
      - uses: actions/checkout@v4

      - name: Prepare SSH private key
        run: |
          install -m 600 /dev/null "${RUNNER_TEMP}/id_rsa"
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > "${RUNNER_TEMP}/id_rsa"
          echo "TF_VAR_ssh_private_key_path=${RUNNER_TEMP}/id_rsa" >> "$GITHUB_ENV"

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.1

      - name: Terraform fmt
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: terraform init -input=false

      # - name: Terraform plan
      #   id: plan
      #   working-directory: ${{ env.TF_WORKING_DIR }}
      #   env:
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      #   run: |
      #     terraform plan -detailed-exitcode -out=tfplan
      #     PLAN_EXIT_CODE=$? 
      #     echo "Terraform plan exit code: $PLAN_EXIT_CODE"            
      #     if [ $PLAN_EXIT_CODE -eq 1 ]; then
      #       echo "Terraform plan failed"
      #       exit 1
      #     fi            
      #     echo "exitcode=$PLAN_EXIT_CODE" >> "$GITHUB_OUTPUT"
      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: |
          echo Starting Terraform ......................
          plan_output=$(terraform plan -no-color -out=tfplan 2>&1)
          echo "${plan_output}"
          
          echo "drift_detected=false" >> $GITHUB_OUTPUT
          echo "plan_text<<EOF" >> $GITHUB_OUTPUT
          echo "${plan_output}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if echo "${plan_output}" | grep -q 'Plan:'; then
            if ! echo "${plan_output}" | grep -q 'No changes.'; then
              echo "Drift detected. Setting drift_detected=true"
              echo "drift_detected=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          if ! echo "${plan_output}" | grep -q -e 'Plan:' -e 'No changes.'; then
            echo "::error::Terraform plan failed with an error."
            exit 1
          fi

      - name: Capture plan text
        if: steps.plan.outputs.drift_detected == 'true'
        id: show
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform show -no-color tfplan > plan.txt
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat plan.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Email drift alert
        if: steps.plan.outputs.drift_detected == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[Terraform] Drift detected for TODO App Infrastructure"
          to: ${{ secrets.DRIFT_EMAIL_TO }}
          from: Terraform Bot
          content_type: text/plain
          body: |
            Drift has been detected in the Terraform plan for devops-stage6.
      
            Plan details:
            ${{ steps.show.outputs.body }}
      
            View the workflow run here:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}


      - name: Upload plan artifact
        if: steps.plan.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_WORKING_DIR }}/tfplan

  apply:
    needs: plan
    if: needs.plan.outputs.drift_detected == 'true'
    runs-on: ubuntu-latest
    env:
      TF_VAR_base_domain: ${{ secrets.BASE_DOMAIN }}
      TF_VAR_traefik_acme_email: ${{ secrets.TRAEFIK_ACME_EMAIL }}
      TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      TF_VAR_auth_jwt_secret: ${{ secrets.AUTH_JWT_SECRET }}
      TF_VAR_todos_jwt_secret: ${{ secrets.TODOS_JWT_SECRET }}
      TF_VAR_users_jwt_secret: ${{ secrets.USERS_JWT_SECRET }}
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4

      - name: Prepare SSH private key
        run: |
          install -m 600 /dev/null "${RUNNER_TEMP}/id_rsa"
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > "${RUNNER_TEMP}/id_rsa"
          echo "TF_VAR_ssh_private_key_path=${RUNNER_TEMP}/id_rsa" >> "$GITHUB_ENV"

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: terraform init -input=false

      - name: Terraform apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        run: terraform apply -input=false tfplan
